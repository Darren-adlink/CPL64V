<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPL64V Portal</title>
    <style>
        body { margin: 0; padding: 0; background-color: #0f172a; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Header */
        header { 
            background: #1e293b; color: white; padding: 0 20px; height: 50px; 
            display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 1px solid #334155; flex-shrink: 0;
        }
        h1 { margin: 0; font-size: 18px; font-weight: 500; display: flex; align-items: center; gap: 10px; }
        
        /* Layout */
        .main-container { display: flex; flex: 1; overflow: hidden; }
        
        /* Sidebar */
        .sidebar-list { width: 320px; background: #1e293b; border-right: 1px solid #334155; display: flex; flex-direction: column; flex-shrink: 0; z-index: 10; }
        .filter-section { padding: 15px; background: #0f172a; border-bottom: 1px solid #334155; display: flex; flex-direction: column; gap: 10px; }
        .filter-label { font-size: 11px; color: #94a3b8; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .filter-select { width: 100%; background: #334155; color: white; border: 1px solid #475569; padding: 8px; border-radius: 6px; font-size: 14px; outline: none; }
        .filter-select:disabled { opacity: 0.5; cursor: not-allowed; }
        .filter-select:focus { border-color: #2563eb; }
        .list-header { padding: 10px 15px; color: #64748b; font-size: 11px; font-weight: bold; background: #162032; border-bottom: 1px solid #334155; display: flex; justify-content: space-between; }
        
        /* List */
        .camera-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
        .camera-item { padding: 12px 15px; border-bottom: 1px solid #334155; cursor: pointer; transition: background 0.2s; display: flex; gap: 12px; align-items: center; }
        .camera-item:hover { background: #334155; }
        .camera-item.active { background: #2563eb; border-color: #2563eb; }
        .camera-item.active .info-variant { color: white; }
        .item-thumb { width: 60px; height: 45px; object-fit: cover; border-radius: 4px; background: #0f172a; border: 1px solid #475569; flex-shrink: 0; }
        .item-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; }
        .info-variant { font-size: 14px; color: #e2e8f0; font-weight: 500; }
        .info-meta { font-size: 11px; color: #94a3b8; }
        .list-empty { padding: 30px 20px; text-align: center; color: #64748b; font-size: 13px; display: flex; flex-direction: column; align-items: center; gap: 10px; }

        /* Content Area */
        .content-area { flex: 1; display: flex; position: relative; background: #0f172a; }
        .panel-source { flex: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; border-right: 1px solid #334155; background: #0f172a; }
        .panel-target { flex: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; background: #0f172a; }
        
        /* UI Elements */
        .panel-label { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.6); color: #cbd5e1; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; pointer-events: none; z-index: 5; border: 1px solid rgba(255,255,255,0.1); }
        .loading-overlay { position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(15,23,42,0.9); color: white; display: flex; justify-content: center; align-items: center; z-index: 20; font-size: 14px; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        .loading-overlay.active { opacity: 1; pointer-events: all; }
        
        /* Footer Info */
        .info-footer { height: 140px; background: #1e293b; color: #e2e8f0; padding: 20px 30px; flex-shrink: 0; box-shadow: 0 -4px 10px rgba(0,0,0,0.2); display: flex; flex-direction: column; justify-content: center; }
        .info-title { font-size: 18px; font-weight: bold; color: #60a5fa; margin-bottom: 8px; display: flex; align-items: center; gap: 10px; }
        .info-mapping { font-size: 14px; background: #3b82f6; color: white; padding: 2px 8px; border-radius: 4px; font-weight: normal; }
        .info-desc { font-size: 14px; color: #94a3b8; line-height: 1.6; max-width: 800px; white-space: pre-wrap; }
        .info-placeholder { color: #475569; font-style: italic; }

        /* Misc */
        .right-container { flex: 1; display: flex; flex-direction: column; background: #0f172a; overflow: hidden; }
        .images-row { flex: 1; display: flex; overflow: hidden; border-bottom: 1px solid #334155; }
        .demo-badge { background: #f59e0b; color: #fff; font-size: 11px; padding: 2px 6px; border-radius: 4px; margin-left: 10px; display: none; }
        
        /* è¨ªå®¢è¨ˆæ•¸å™¨å®¹å™¨ */
        .visitor-count-container { font-size: 12px; color: #94a3b8; display: flex; align-items: center; gap: 8px; padding: 4px 10px; border-radius: 20px; background: #334155; border: 1px solid #475569;}
        .visitor-badge { display: block; height: 20px; }

        .lang-select { background: #334155; color: white; border: 1px solid #475569; padding: 4px 8px; border-radius: 4px; font-size: 13px; outline: none; cursor: pointer; }
        .scanning-text { animation: pulse 1.5s infinite; color: #2563eb; font-weight: bold; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
    </style>
</head>
<body>

<header>
    <h1>ğŸ¯ CPL64V Portal <span id="demoBadge" class="demo-badge">Demo</span></h1>
    <div style="display:flex; align-items:center; gap:15px;">
        
        <!-- è¨ªå®¢è¨ˆæ•¸å™¨ (ç„¡ Firebase ç‰ˆæœ¬) -->
        <div class="visitor-count-container" title="Total Views">
            <span>Views:</span>
            <div id="visitorBadge">Loading...</div>
        </div>

        <div style="display:flex; align-items:center; gap:10px;">
            <span style="font-size:12px; color:#94a3b8;">v8.0 No-Firebase</span>
            <select id="langSelect" class="lang-select" onchange="changeLanguage(this.value)">
                <option value="en">English</option>
                <option value="zh_TW" selected>ç¹é«”ä¸­æ–‡</option>
                <option value="zh_CN">ç®€ä½“ä¸­æ–‡</option>
                <option value="ja">æ—¥æœ¬èª</option>
                <option value="ko">í•œêµ­ì–´</option>
            </select>
        </div>
    </div>
</header>

<div class="main-container">
    
    <!-- 1. å·¦å´é¸å–® -->
    <div class="sidebar-list">
        <div class="filter-section">
            <div>
                <div class="filter-label" data-i18n="select_brand">1. Select Brand</div>
                <select id="brandSelect" class="filter-select" onchange="onBrandChange()">
                    <option value="" disabled selected data-i18n="default_brand">-- é¸æ“‡å“ç‰Œ --</option>
                </select>
            </div>
            <div>
                <div class="filter-label" data-i18n="select_model">2. Select Model</div>
                <select id="modelSelect" class="filter-select" disabled onchange="onModelChange()">
                    <option value="" disabled selected data-i18n="default_model">-- é¸æ“‡å‹è™Ÿ --</option>
                </select>
            </div>
        </div>
        <div class="list-header">
            <span data-i18n="available_configs">AVAILABLE CONFIGS</span>
            <span id="listCount">0 Items</span>
        </div>
        <ul class="camera-list" id="cameraListContainer">
            <div class="list-empty"><span data-i18n="hint_select">ğŸ‘ˆ è«‹å…ˆé¸æ“‡å“ç‰Œèˆ‡å‹è™Ÿ</span></div>
        </ul>
    </div>

    <div class="right-container">
        <div class="images-row">
            <div class="panel-source" id="canvasWrapper" onwheel="handleZoom(event)">
                <div class="panel-label" id="lblSource" data-i18n="label_source">ğŸ“· ç›¸æ©Ÿè¨­å®š (Source)</div>
                <div id="loading" class="loading-overlay active" data-i18n="loading_text">è«‹å¾å·¦å´åˆ—è¡¨é¸æ“‡åœ–ç‰‡</div>
                <canvas id="mainCanvas"></canvas>
            </div>
            <div class="panel-target" id="targetWrapper" onwheel="handleTargetZoom(event)">
                <div class="panel-label" data-i18n="label_target">ğŸ› ï¸ CPL64V ç”¢å“ (Target)</div>
                <canvas id="targetCanvas"></canvas>
            </div>
        </div>
        <div class="info-footer">
            <div id="infoContent">
                <div class="info-title">
                    <span id="pNameDisplay">--</span>
                    <span id="pMappingDisplay" class="info-mapping" style="display:none;"></span>
                </div>
                <div class="info-desc" id="pDescDisplay">
                    <span class="info-placeholder" data-i18n="placeholder_desc">è«‹å°‡æ»‘é¼ æ¸¸æ¨™ç§»å‹•åˆ°ç¶ è‰²æ¡†æ¡†ä¸Šæ–¹ä»¥æŸ¥çœ‹è©³ç´°èªªæ˜ã€‚</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Simple Script for Visitor Badge (No Firebase) -->
<script>
    // è‡ªå‹•ç”¢ç”Ÿè¨ˆæ•¸å™¨åœ–ç‰‡
    function initVisitorBadge() {
        const container = document.getElementById('visitorBadge');
        container.innerHTML = ''; // Clear loading
        
        // å–å¾—ç•¶å‰ç¶²å€çš„ä¸»æ©Ÿåç¨± (ä¾‹å¦‚: cpl64v.vercel.app)
        // æ³¨æ„ï¼šæœ¬åœ°é–‹ç™¼ (localhost) æˆ– é è¦½ç¶²å€ ä¹Ÿæœƒè¢«è¨ˆç®—
        // ä½¿ç”¨ hits.seeyoufarm.com å…è²»æœå‹™
        const currentUrl = window.location.host || 'local-dev';
        const targetUrl = `https://${currentUrl}/`;
        
        const img = document.createElement('img');
        img.className = 'visitor-badge';
        // ä½¿ç”¨è—è‰²ä¸»é¡Œï¼Œæ¨™é¡Œæ˜¯ "visits"
        img.src = `https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=${encodeURIComponent(targetUrl)}&count_bg=%232563EB&title_bg=%231E293B&icon=&icon_color=%23E7E7E7&title=hits&edge_flat=false`;
        img.alt = "Visitor Count";
        
        container.appendChild(img);
    }
    
    // åˆå§‹åŒ–è¨ˆæ•¸å™¨
    initVisitorBadge();
</script>

<script>
    // --- i18n ---
    let currentLang = 'zh_TW';
    const translations = {
        en: { select_brand:"1. Select Brand", select_model:"2. Select Model", default_brand:"-- Select Brand --", default_model:"-- Select Model --", available_configs:"AVAILABLE CONFIGS", items_count:"{n} Items", hint_select:"ğŸ‘ˆ Select Brand & Model", label_source:"ğŸ“· Camera Settings (Source)", label_target:"ğŸ› ï¸ CPL64V Product (Target)", loading_text:"Select an image from the list", scanning:"ğŸ” Verifying images...", no_data:"No Data", valid_configs:"{n} Valid Configs", no_valid_images:"âŒ No valid images", default_config:"Default Config", updated:"Updated: ", placeholder_desc:"Hover over the green boxes to see details.", no_desc:"No description available", mapped_to:"Mapped to: " },
        zh_TW: { select_brand:"1. é¸æ“‡å“ç‰Œ", select_model:"2. é¸æ“‡å‹è™Ÿ", default_brand:"-- é¸æ“‡å“ç‰Œ --", default_model:"-- é¸æ“‡å‹è™Ÿ --", available_configs:"å¯ç”¨é…ç½®", items_count:"{n} é …ç›®", hint_select:"ğŸ‘ˆ è«‹å…ˆé¸æ“‡å“ç‰Œèˆ‡å‹è™Ÿ", label_source:"ğŸ“· ç›¸æ©Ÿè¨­å®š (Source)", label_target:"ğŸ› ï¸ CPL64V ç”¢å“ (Target)", loading_text:"è«‹å¾å·¦å´åˆ—è¡¨é¸æ“‡åœ–ç‰‡", scanning:"ğŸ” æ­£åœ¨æƒæåœ–ç‰‡æœ‰æ•ˆæ€§...", no_data:"ç„¡è³‡æ–™", valid_configs:"{n} å€‹æœ‰æ•ˆé…ç½®", no_valid_images:"âŒ ç„¡æœ‰æ•ˆåœ–ç‰‡è³‡æ–™", default_config:"é è¨­é…ç½®", updated:"æ›´æ–°æ–¼: ", placeholder_desc:"è«‹å°‡æ»‘é¼ æ¸¸æ¨™ç§»å‹•åˆ°ç¶ è‰²æ¡†æ¡†ä¸Šæ–¹ä»¥æŸ¥çœ‹è©³ç´°èªªæ˜ã€‚", no_desc:"æš«ç„¡è©³ç´°èªªæ˜", mapped_to:"å°æ‡‰è‡³: " },
        zh_CN: { select_brand:"1. é€‰æ‹©å“ç‰Œ", select_model:"2. é€‰æ‹©å‹å·", default_brand:"-- é€‰æ‹©å“ç‰Œ --", default_model:"-- é€‰æ‹©å‹å· --", available_configs:"å¯ç”¨é…ç½®", items_count:"{n} é¡¹ç›®", hint_select:"ğŸ‘ˆ è¯·å…ˆé€‰æ‹©å“ç‰Œä¸å‹å·", label_source:"ğŸ“· ç›¸æœºè®¾å®š (Source)", label_target:"ğŸ› ï¸ CPL64V äº§å“ (Target)", loading_text:"è¯·ä»å·¦ä¾§åˆ—è¡¨é€‰æ‹©å›¾ç‰‡", scanning:"ğŸ” æ­£åœ¨æ‰«æå›¾ç‰‡æœ‰æ•ˆæ€§...", no_data:"æ— æ•°æ®", valid_configs:"{n} ä¸ªæœ‰æ•ˆé…ç½®", no_valid_images:"âŒ æ— æœ‰æ•ˆå›¾ç‰‡æ•°æ®", default_config:"é»˜è®¤é…ç½®", updated:"æ›´æ–°äº: ", placeholder_desc:"è¯·å°†é¼ æ ‡å…‰æ ‡ç§»åŠ¨åˆ°ç»¿è‰²æ¡†æ¡†ä¸Šæ–¹ä»¥æŸ¥çœ‹è¯¦ç»†è¯´æ˜ã€‚", no_desc:"æš‚æ— è¯¦ç»†è¯´æ˜", mapped_to:"å¯¹åº”è‡³: " },
        ja: { select_brand:"1. ãƒ–ãƒ©ãƒ³ãƒ‰ã‚’é¸æŠ", select_model:"2. ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ", default_brand:"-- ãƒ–ãƒ©ãƒ³ãƒ‰ã‚’é¸æŠ --", default_model:"-- ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ --", available_configs:"åˆ©ç”¨å¯èƒ½ãªè¨­å®š", items_count:"{n} é …ç›®", hint_select:"ğŸ‘ˆ ãƒ–ãƒ©ãƒ³ãƒ‰ã¨ãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠ", label_source:"ğŸ“· ã‚«ãƒ¡ãƒ©è¨­å®š (Source)", label_target:"ğŸ› ï¸ CPL64V è£½å“ (Target)", loading_text:"å·¦ã®ãƒªã‚¹ãƒˆã‹ã‚‰ç”»åƒã‚’é¸æŠ", scanning:"ğŸ” ç”»åƒã‚’ç¢ºèªä¸­...", no_data:"ãƒ‡ãƒ¼ã‚¿ãªã—", valid_configs:"{n} æœ‰åŠ¹ãªè¨­å®š", no_valid_images:"âŒ æœ‰åŠ¹ãªç”»åƒãŒã‚ã‚Šã¾ã›ã‚“", default_config:"ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š", updated:"æ›´æ–°æ—¥: ", placeholder_desc:"ç·‘è‰²ã®æ ã®ä¸Šã«ãƒã‚¦ã‚¹ã‚’ç½®ãã¨è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚", no_desc:"è©³ç´°ãªã—", mapped_to:"ãƒãƒƒãƒ”ãƒ³ã‚°: " },
        ko: { select_brand:"1. ë¸Œëœë“œ ì„ íƒ", select_model:"2. ëª¨ë¸ ì„ íƒ", default_brand:"-- ë¸Œëœë“œ ì„ íƒ --", default_model:"-- ëª¨ë¸ ì„ íƒ --", available_configs:"ì‚¬ìš© ê°€ëŠ¥í•œ ì„¤ì •", items_count:"{n} í•­ëª©", hint_select:"ğŸ‘ˆ ë¸Œëœë“œ ë° ëª¨ë¸ ì„ íƒ", label_source:"ğŸ“· ì¹´ë©”ë¼ ì„¤ì • (Source)", label_target:"ğŸ› ï¸ CPL64V ì œí’ˆ (Target)", loading_text:"ì™¼ìª½ ëª©ë¡ì—ì„œ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”", scanning:"ğŸ” ì´ë¯¸ì§€ í™•ì¸ ì¤‘...", no_data:"ë°ì´í„° ì—†ìŒ", valid_configs:"{n} ìœ íš¨í•œ ì„¤ì •", no_valid_images:"âŒ ìœ íš¨í•œ ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤", default_config:"ê¸°ë³¸ ì„¤ì •", updated:"ì—…ë°ì´íŠ¸: ", placeholder_desc:"ë…¹ìƒ‰ ìƒì ìœ„ë¡œ ë§ˆìš°ìŠ¤ë¥¼ ê°€ì ¸ê°€ë©´ ìì„¸í•œ ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.", no_desc:"ìƒì„¸ ì„¤ëª… ì—†ìŒ", mapped_to:"ë§¤í•‘: " }
    };
    function t(key,p={}){let x=translations[currentLang][key]||key;for(let k in p)x=x.replace(`{${k}}`,p[k]);return x;}
    function changeLanguage(l){currentLang=l;updateTexts();}
    function getLocalizedDesc(d){if(!d)return t('no_desc');if(typeof d==='string')return d;return d[currentLang]||d['en']||t('no_desc');}
    let displayedParam=null;
    function updateTexts(){
        document.querySelectorAll('[data-i18n]').forEach(el=>{const k=el.getAttribute('data-i18n');if(k)el.innerText=t(k);});
        const bs=document.getElementById('brandSelect');if(bs.options[0].disabled)bs.options[0].text=t('default_brand');
        const ms=document.getElementById('modelSelect');if(ms.options[0].disabled)ms.options[0].text=t('default_model');
        const el=document.querySelector('.list-empty span');if(el&&!ms.value)el.innerText=t('hint_select');
        const ld=document.getElementById('loading');if(ld.classList.contains('active')&&!currentCamera)ld.innerText=t('loading_text');
        
        // Dynamic Label Update
        const lblSource = document.getElementById('lblSource');
        if (currentCamera) {
             // Only update if language changed or first load, preserve model info
             // Actually, simplest is to rebuild string. But we only have camData in loadCamera.
             // We can store currentCamera (global) and use it.
             lblSource.innerText = `ğŸ“· Source: ${currentCamera.brand} - ${currentCamera.model}`;
        } else {
             lblSource.innerText = t('label_source');
        }

        if(displayedParam) updateInfoPanel(displayedParam);
        else if(document.querySelector('.info-placeholder')) document.querySelector('.info-placeholder').innerText=t('placeholder_desc');
    }

    const GITHUB_USER='Darren-adlink', GITHUB_REPO='CPL64V', DATA_PATH='cpl64v-camera-mapping/data/cameras.json';
    const DB_URL=`https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/${DATA_PATH}`;
    const canvas=document.getElementById('mainCanvas'), ctx=canvas.getContext('2d');
    const targetCanvas=document.getElementById('targetCanvas'), targetCtx=targetCanvas.getContext('2d');
    const brandSelect=document.getElementById('brandSelect'), modelSelect=document.getElementById('modelSelect'), listContainer=document.getElementById('cameraListContainer'), loading=document.getElementById('loading');
    const elName=document.getElementById('pNameDisplay'), elMapping=document.getElementById('pMappingDisplay'), elDesc=document.getElementById('pDescDisplay');
    
    let fullDB={}, hierarchy={}, currentCamera=null, img=new Image(), targetImgObj=new Image();
    let scale=1, offsetX=0, offsetY=0, targetScale=1, targetOffsetX=0, targetOffsetY=0, hoverIndex=-1;
    let isDragging=false, startX=0, startY=0, isDraggingTarget=false, startXTarget=0, startYTarget=0;

    async function init(){
        try{
            const res=await fetch(`${DB_URL}?t=${Date.now()}`);
            if(!res.ok)throw new Error(`HTTP ${res.status}`);
            fullDB=await res.json(); buildHierarchy(); populateBrandSelect();
        }catch(e){
            console.warn("Load failed, using mock:",e);
            document.getElementById('demoBadge').style.display='inline-block';
            fullDB={"demo":{brand:"Basler",model:"acA1920",variant:"Trigger",imageUrl:"https://placehold.co/400x300",targetImageUrl:"",params:[]}};
            buildHierarchy(); populateBrandSelect();
        }
        updateTexts();
    }

    function buildHierarchy(){
        hierarchy={};
        Object.keys(fullDB).forEach(k=>{
            const e=fullDB[k], b=e.brand||"Unknown", m=e.model||"Unknown";
            if(!hierarchy[b])hierarchy[b]={}; if(!hierarchy[b][m])hierarchy[b][m]=[];
            hierarchy[b][m].push({id:k,...e});
        });
    }

    function populateBrandSelect(){
        brandSelect.innerHTML=`<option value="" disabled selected>${t('default_brand')}</option>`;
        Object.keys(hierarchy).sort().forEach(b=>brandSelect.innerHTML+=`<option value="${b}">${b}</option>`);
        modelSelect.innerHTML=`<option value="" disabled selected>${t('default_model')}</option>`;
        modelSelect.disabled=true; listContainer.innerHTML=`<div class="list-empty"><span>${t('hint_select')}</span></div>`;
    }

    window.onBrandChange=()=>{
        const b=brandSelect.value, ms=Object.keys(hierarchy[b]||{}).sort();
        modelSelect.innerHTML=`<option value="" disabled selected>${t('default_model')}</option>`;
        ms.forEach(m=>modelSelect.innerHTML+=`<option value="${m}">${m}</option>`);
        modelSelect.disabled=false; listContainer.innerHTML=`<div class="list-empty"><span>${t('hint_select')}</span></div>`;
        document.getElementById('listCount').innerText=t('items_count',{n:0});
    };

    window.onModelChange=async()=>{
        const b=brandSelect.value, m=modelSelect.value, entries=hierarchy[b][m];
        listContainer.innerHTML=`<div class="list-empty"><span class="scanning-text">${t('scanning')}</span></div>`;
        document.getElementById('listCount').innerText="...";
        if(!entries||!entries.length){ listContainer.innerHTML=`<div class="list-empty">${t('no_data')}</div>`; return;}
        
        const check=e=>new Promise(r=>{const i=new Image();i.onload=()=>r(e);i.onerror=()=>r(null);i.src=e.imageUrl+(e.imageUrl.includes('?')?'&':'?')+'t='+Date.now();});
        const valid= (await Promise.all(entries.map(check))).filter(i=>i!==null);
        valid.sort((a, b) => (a.variant || "").localeCompare(b.variant || ""));

        listContainer.innerHTML=''; document.getElementById('listCount').innerText=t('valid_configs',{n:valid.length});
        if(!valid.length){ listContainer.innerHTML=`<div class="list-empty">${t('no_valid_images')}</div>`; return; }
        
        valid.forEach(e=>{
            const li=document.createElement('li'); li.className='camera-item';
            li.innerHTML=`<img src="${e.imageUrl}" class="item-thumb"><div class="item-info"><span class="info-variant">${e.variant||t('default_config')}</span><span class="info-meta">${t('updated')}${new Date(e.updatedAt).toLocaleDateString()}</span></div>`;
            li.onclick=()=>{
                document.querySelectorAll('.camera-item').forEach(el=>el.classList.remove('active'));
                li.classList.add('active'); loadCamera(e);
            };
            listContainer.appendChild(li);
        });
    };

    function loadCamera(d){
        currentCamera=d; loading.classList.add('active'); loading.innerText="Loading...";
        document.getElementById('lblSource').innerText=`ğŸ“· Source: ${d.brand} - ${d.model}`;
        updateInfoPanel(null);

        img=new Image(); img.crossOrigin="Anonymous";
        img.onload=()=>{
            const c=document.getElementById('canvasWrapper'); canvas.width=c.clientWidth; canvas.height=c.clientHeight;
            applyAutoZoomAndFocus(); loading.classList.remove('active'); draw();
            if(currentCamera.params.length) updateInfoPanel(currentCamera.params[0]);
        };
        img.onerror=()=>{loading.innerText="Error";}; img.src=d.imageUrl;

        targetImgObj=new Image(); targetImgObj.crossOrigin="Anonymous";
        targetImgObj.onload=()=>{resetView('target');drawTarget();};
        targetImgObj.src=d.targetImageUrl||"https://placehold.co/600x400/1e293b/fff?text=No+Target+Image";
    }

    function applyAutoZoomAndFocus(){
        const c=document.getElementById('canvasWrapper');
        if(canvas.width!==c.clientWidth||canvas.height!==c.clientHeight){canvas.width=c.clientWidth;canvas.height=c.clientHeight;}
        if(currentCamera.params.length){
            const p=currentCamera.params[0].roi;
            const targetMinSide = 200;
            const roiMinSide = Math.min(p.w, p.h);
            let scaleByDetail = targetMinSide / roiMinSide;
            const margin = 40;
            const availableW = canvas.width - margin;
            const availableH = canvas.height - margin;
            let scaleByFit = Math.min(availableW / p.w, availableH / p.h);
            scale = Math.min(Math.max(Math.min(scaleByDetail, scaleByFit), 0.1), 5.0);
            
            offsetX=(canvas.width/2)-((p.x+p.w/2)*scale);
            offsetY=(canvas.height/2)-((p.y+p.h/2)*scale);
            hoverIndex=0;
        }else{
            scale=Math.min((canvas.width-40)/img.width,(canvas.height-40)/img.height);
            offsetX=(canvas.width-img.width*scale)/2; offsetY=(canvas.height-img.height*scale)/2;
            hoverIndex=-1;
        }
    }

    function resetView(t){
        if(t==='target'){
            const c=document.getElementById('targetWrapper'); targetCanvas.width=c.clientWidth; targetCanvas.height=c.clientHeight;
            targetScale=Math.min((targetCanvas.width-40)/targetImgObj.width,(targetCanvas.height-40)/targetImgObj.height);
            targetOffsetX=(targetCanvas.width-targetImgObj.width*targetScale)/2;
            targetOffsetY=(targetCanvas.height-targetImgObj.height*targetScale)/2;
        }
    }

    function draw(){
        if(!currentCamera||!img.complete)return;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(img,offsetX,offsetY,img.width*scale,img.height*scale);
        ctx.fillStyle="rgba(0,0,0,0.6)"; ctx.fillRect(0,0,canvas.width,canvas.height);
        currentCamera.params.forEach((p,i)=>{
            const sx=p.roi.x*scale+offsetX, sy=p.roi.y*scale+offsetY, sw=p.roi.w*scale, sh=p.roi.h*scale;
            ctx.drawImage(img,p.roi.x,p.roi.y,p.roi.w,p.roi.h,sx,sy,sw,sh);
            const h=i===hoverIndex;
            ctx.lineWidth=h?3:2; ctx.strokeStyle=h?"#00ff00":"rgba(255,255,255,0.5)"; ctx.setLineDash(h?[]:[5,3]);
            ctx.strokeRect(sx,sy,sw,sh);
            if(h){
                const l=`${p.name} â¤ ${p.cpl_setting||''}`; ctx.font="bold 14px Arial";
                const w=ctx.measureText(l).width; ctx.fillStyle="#00ff00"; ctx.fillRect(sx,sy-24,w+10,24);
                ctx.fillStyle="#000"; ctx.fillText(l,sx+5,sy-7);
            }
        });
    }
    
    function drawTarget(){
        if(!targetImgObj.complete)return;
        targetCtx.clearRect(0,0,targetCanvas.width,targetCanvas.height);
        targetCtx.drawImage(targetImgObj,targetOffsetX,targetOffsetY,targetImgObj.width*targetScale,targetImgObj.height*targetScale);
    }

    function updateInfoPanel(p){
        displayedParam=p;
        if(p){
            elName.innerText=p.name;
            elMapping.style.display=p.cpl_setting?'inline-block':'none';
            if(p.cpl_setting) elMapping.innerText=t('mapped_to')+p.cpl_setting;
            elDesc.innerHTML=getLocalizedDesc(p.desc); elDesc.style.color='#e2e8f0';
        }else{
            elName.innerText='--'; elMapping.style.display='none';
            elDesc.innerHTML=`<span class="info-placeholder">${t('placeholder_desc')}</span>`;
        }
    }

    // Events
    canvas.addEventListener('mousedown',e=>{isDragging=true;startX=e.clientX;startY=e.clientY;});
    canvas.addEventListener('mousemove',e=>{
        if(!currentCamera)return;
        if(isDragging){offsetX+=e.clientX-startX;offsetY+=e.clientY-startY;startX=e.clientX;startY=e.clientY;draw();return;}
        const r=canvas.getBoundingClientRect(), mx=(e.clientX-r.left-offsetX)/scale, my=(e.clientY-r.top-offsetY)/scale;
        let f=-1; currentCamera.params.forEach((p,i)=>{if(mx>=p.roi.x&&mx<=p.roi.x+p.roi.w&&my>=p.roi.y&&my<=p.roi.y+p.roi.h)f=i;});
        if(f!==hoverIndex){hoverIndex=f;draw();if(f!==-1)updateInfoPanel(currentCamera.params[f]);}
    });
    targetCanvas.addEventListener('mousedown',e=>{isDraggingTarget=true;startXTarget=e.clientX;startYTarget=e.clientY;});
    targetCanvas.addEventListener('mousemove',e=>{
        if(isDraggingTarget){targetOffsetX+=e.clientX-startXTarget;targetOffsetY+=e.clientY-startYTarget;startXTarget=e.clientX;startYTarget=e.clientY;drawTarget();}
    });
    window.addEventListener('mouseup',()=>{isDragging=false;isDraggingTarget=false;});
    
    window.handleZoom=e=>{
        e.preventDefault(); if(!img.complete)return;
        const r=canvas.getBoundingClientRect(), mx=e.clientX-r.left, my=e.clientY-r.top;
        const ix=(mx-offsetX)/scale, iy=(my-offsetY)/scale;
        const ns=scale*(e.deltaY>0?0.9:1.1); if(ns<0.1||ns>10)return;
        scale=ns; offsetX=mx-ix*scale; offsetY=my-iy*scale; draw();
    };
    window.handleTargetZoom=e=>{
        e.preventDefault(); if(!targetImgObj.complete)return;
        const r=targetCanvas.getBoundingClientRect(), mx=e.clientX-r.left, my=e.clientY-r.top;
        const ix=(mx-targetOffsetX)/targetScale, iy=(my-targetOffsetY)/targetScale;
        const ns=targetScale*(e.deltaY>0?0.9:1.1); if(ns<0.1||ns>10)return;
        targetScale=ns; targetOffsetX=mx-ix*targetScale; targetOffsetY=my-iy*targetScale; drawTarget();
    };
    window.addEventListener('resize',()=>{if(currentCamera){resetView('source');draw();resetView('target');drawTarget();}});
    window.changeLanguage=changeLanguage;
    
    init();
</script>
</body>
</html>
